<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Water Selling & Refilling Demo</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f8ff;
    margin: 0;
    padding: 0 1rem;
  }
  header {
    background: #0077b6;
    color: white;
    padding: 1rem;
    text-align: center;
  }
  h1 {
    margin: 0;
  }
  #auth-section, #product-section, #order-section {
    margin: 1rem auto;
    max-width: 600px;
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  input, select, button {
    font-size: 1rem;
    margin: 0.5rem 0;
    padding: 0.4rem;
    width: 100%;
    box-sizing: border-box;
    border: 1px solid #0077b6;
    border-radius: 4px;
  }
  button {
    background: #0077b6;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #005f86;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #ddd;
  }
  label {
    display: block;
  }
  .hidden {
    display: none;
  }
  #message {
    margin: 1rem 0;
    color: red;
  }
</style>
</head>
<body>
<header>
  <h1>Water Selling & Refilling Demo</h1>
</header>

<section id="auth-section">
  <h2>User Registration</h2>
  <input type="text" id="reg-username" placeholder="Username" />
  <input type="email" id="reg-email" placeholder="Email" />
  <input type="password" id="reg-password" placeholder="Password" />
  <button id="register-btn">Register</button>

  <h2>User Login</h2>
  <input type="text" id="login-username" placeholder="Username" />
  <input type="password" id="login-password" placeholder="Password" />
  <button id="login-btn">Login</button>

  <div id="message"></div>
</section>

<section id="product-section" class="hidden">
  <h2>Product Catalog</h2>
  <ul id="product-list"></ul>
</section>

<section id="order-section" class="hidden">
  <h2>Create Order</h2>
  <label for="product-select">Select Product</label>
  <select id="product-select"></select>
  <label for="order-quantity">Quantity</label>
  <input type="number" id="order-quantity" min="1" value="1" />
  <button id="order-btn">Place Order</button>

  <h2>Your Orders</h2>
  <ul id="order-list"></ul>
</section>

<script>
const API_BASE = 'http://127.0.0.1:8000/api';
let token = localStorage.getItem('authToken') || '';

const messageEl = document.getElementById('message');
const authSection = document.getElementById('auth-section');
const productSection = document.getElementById('product-section');
const orderSection = document.getElementById('order-section');
const productListEl = document.getElementById('product-list');
const productSelect = document.getElementById('product-select');
const orderListEl = document.getElementById('order-list');

function showMessage(msg, isError=true) {
  messageEl.textContent = msg;
  messageEl.style.color = isError ? 'red' : 'green';
  setTimeout(() => { messageEl.textContent = ''; }, 4000);
}

async function register() {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  if (!username || !email || !password) {
    showMessage('Fill all registration fields.');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/register/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, email, password})
    });
    if (res.ok) {
      showMessage('Registration successful! You can now login.', false);
      document.getElementById('reg-username').value = '';
      document.getElementById('reg-email').value = '';
      document.getElementById('reg-password').value = '';
    } else {
      const data = await res.json();
      let err = JSON.stringify(data);
      if(data.password) err = data.password.join(' ');
      else if(data.username) err = data.username.join(' ');
      showMessage(err);
    }
  } catch(e) {
    showMessage('Error during registration. ' + e.message);
  }
}

async function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) {
    showMessage('Fill both login fields.');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/login/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password})
    });
    if (res.ok) {
      const data = await res.json();
      token = data.token;
      localStorage.setItem('authToken', token);
      showMessage('Login successful!', false);
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      afterLogin();
    } else {
      showMessage('Invalid username or password.');
    }
  } catch(e) {
    showMessage('Error during login. ' + e.message);
  }
}

async function fetchProducts() {
  try {
    const res = await fetch(`${API_BASE}/products/`);
    if (res.ok) {
      const products = await res.json();
      productListEl.innerHTML = '';
      productSelect.innerHTML = '<option value="">Select a product</option>';
      products.forEach(prod => {
        const li = document.createElement('li');
        li.textContent = `${prod.name} - $${prod.price.toFixed(2)} [Stock: ${prod.stock}]`;
        productListEl.appendChild(li);
        if (prod.stock > 0) {
          const option = document.createElement('option');
          option.value = prod.id;
          option.textContent = prod.name;
          productSelect.appendChild(option);
        }
      });
    } else {
      productListEl.textContent = 'Failed to load products.';
    }
  } catch(e) {
    productListEl.textContent = 'Error loading products: ' + e.message;
  }
}

async function fetchOrders() {
  if (!token) return;
  try {
    const res = await fetch(`${API_BASE}/orders/`, {
      headers: {'Authorization': 'Token ' + token}
    });
    if (res.ok) {
      const orders = await res.json();
      orderListEl.innerHTML = '';
      if (orders.length === 0) {
        orderListEl.textContent = 'No orders yet.';
      } else {
        orders.forEach(order => {
          const li = document.createElement('li');
          li.textContent = `Order #${order.id}: ${order.product} x ${order.quantity} = $${order.total_price} (Status: ${order.status})`;
          orderListEl.appendChild(li);
        });
      }
    } else {
      orderListEl.textContent = 'Failed to load orders.';
    }
  } catch(e) {
    orderListEl.textContent = 'Error loading orders: ' + e.message;
  }
}

async function placeOrder() {
  const productId = productSelect.value;
  const quantity = parseInt(document.getElementById('order-quantity').value, 10);
  if (!productId) {
    showMessage('Select a product.');
    return;
  }
  if (!quantity || quantity < 1) {
    showMessage('Enter a valid quantity.');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/orders/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Token ' + token
      },
      body: JSON.stringify({product: productId, quantity: quantity})
    });
    if (res.ok) {
      showMessage('Order placed successfully.', false);
      fetchOrders();
      fetchProducts();
      document.getElementById('order-quantity').value = '1';
    } else {
      const errorData = await res.json();
      let errMsg = 'Error placing order.';
      if (typeof errorData === 'object') {
        if (errorData.non_field_errors) errMsg = errorData.non_field_errors.join(' ');
        else errMsg = JSON.stringify(errorData);
      }
      showMessage(errMsg);
    }
  } catch(e) {
    showMessage('Error placing order: ' + e.message);
  }
}

function afterLogin() {
  authSection.classList.add('hidden');
  productSection.classList.remove('hidden');
  orderSection.classList.remove('hidden');
  fetchProducts();
  fetchOrders();
}

function checkLoggedIn() {
  if (token) {
    afterLogin();
  }
}

document.getElementById('register-btn').addEventListener('click', register);
document.getElementById('login-btn').addEventListener('click', login);
document.getElementById('order-btn').addEventListener('click', placeOrder);

checkLoggedIn();
</script>

</body>
</html>
